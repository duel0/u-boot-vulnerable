name: "CodeQL Custom Query Analysis"

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 8 * * 1'  # Esegui ogni lunedì alle 8:00

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'cpp' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # Semplifichiamo l'approccio alle query personalizzate
    - name: Setup Custom CodeQL Queries
      run: |
        mkdir -p .github/codeql/custom-queries/cpp
        
        # Crea la query personalizzata
        cat > .github/codeql/custom-queries/cpp/unsafe-network-data-memcpy.ql << 'EOL'
        /**
         * @name Unsafe network data to memcpy
         * @description Network byte-swapped data flows to memcpy size parameter without validation
         * @kind path-problem
         * @problem.severity error
         * @security-severity 8.0
         * @precision high
         * @id cpp/unsafe-network-memcpy
         * @tags security
         *       external/cwe/cwe-131
         */
        import cpp
        import semmle.code.cpp.dataflow.TaintTracking
        
        class NetworkByteSwap extends Expr {
          NetworkByteSwap() {
            exists(MacroInvocation invocation |
              invocation.getMacro().getName().regexpMatch("ntoh.*") and
              invocation.getExpr() = this
            )
          }
        }
        
        module MyConfig implements DataFlow::ConfigSig {
          predicate isSource(DataFlow::Node source) {
            exists(Expr e | source.asExpr() = e and e instanceof NetworkByteSwap)
          }
          predicate isSink(DataFlow::Node sink) {
            exists(FunctionCall call |
              call.getTarget().hasName("memcpy") and
              sink.asExpr() = call.getArgument(2)
            )
          }
          predicate isBarrier(DataFlow::Node node) {
            node.asExpr().getEnclosingStmt() instanceof IfStmt
          }
        }
        
        module MyTaint = TaintTracking::Global<MyConfig>;
        import MyTaint::PathGraph
        
        from MyTaint::PathNode source, MyTaint::PathNode sink
        where MyTaint::flowPath(source, sink)
        select sink, source, sink, "Network byte swap flows to memcpy size parameter without validation"
        EOL
        
        # Crea un file di suite più semplice
        cat > .github/codeql/cpp-query-suite.qls << 'EOL'
        - description: "Custom query suite for U-Boot"
        - queries: .
          from: .github/codeql/custom-queries/cpp
        - import: codeql-suites/cpp-security-and-quality.qls
          from: codeql-cpp
        EOL

    # Inizializzare CodeQL con configurazione semplificata
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        queries: ./.github/codeql/cpp-query-suite.qls
        debug: true

    # Usa una compilazione più esplicita invece di autobuild
    - name: Build C/C++ Code
      run: |
        # Assicurati che gli strumenti di compilazione siano installati
        sudo apt-get update
        sudo apt-get install -y build-essential
        
        # Esegui la compilazione (adatta questo al tuo sistema di build)
        # Se u-boot usa un sistema di build specifico, sostituisci questi comandi
        make defconfig
        make

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
